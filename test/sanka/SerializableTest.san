// -*- mode: Java; -*-
package sanka.test;
import sanka.json.JsonElement;
import sanka.json.JsonObject;
import sanka.util.Integer;

serializable class Dummy {
    String key;

    Dummy() {
        this.key = "value";
    }
}

serializable class ScalarTest {
    Integer key;
}

serializable class SerializableClass {
    short  s;
    int    i;
    long   lg;
    String str;
    String nullString;
    Dummy  d;
    Dummy  nullDummy;

    short[]  shortArr;
    int[]    nullArr;
    long[]   longArr;
    String[] stringArr;
    Dummy[]  dummyArr;

    void setup() {
        this.s = -1000;
        this.i = 8888;
        this.lg = -2345678901;
        this.str = "column 1" + ((byte) 9) + "column 2";
        this.d = new Dummy();

        this.shortArr = new short[]{ 256, -1 };
        this.longArr = { 54321098765, 17L };
        this.stringArr = { "x", "y", "z" };
        this.dummyArr = { new Dummy(), null, new Dummy() };
    }
}

class SerializableTest extends BaseTest {
    void testSerializableClass() {
        var st = new SerializableClass();
        st.setup();
        var jo = st.toJson().getAsObject();

        var t = new SerializableClass();
        t.fromJson(new JsonElement().makeObject(jo));
        assertTrue(t.s == -1000, "short");
        assertTrue(t.i == 8888, "int");
        assertTrue(t.lg == -2345678901, "long");
        assertTrue(t.str == "column 1" + ((byte) 9) + "column 2", "string");
        assertTrue(t.nullString == null, "null string");
        assertTrue(t.shortArr.length == 2, "short array");
        assertTrue(t.nullArr == null, "null array");
        assertTrue(t.longArr.length == 2, "long array");
        assertTrue(t.stringArr.length == 3, "string array");
        assertTrue(t.longArr[0] == 54321098765, "long array contents");
        assertTrue(t.d.key == "value", "class");
        assertTrue(t.nullDummy == null,  "null class");
        assertTrue(t.dummyArr.length == 3, "class array");
        assertTrue(t.dummyArr[1] == null, "class array null");
        assertTrue(t.dummyArr[2].key == "value", "class array item");

        var text = "{\"s\":\"string\", \"xxx\":17, \"STR\":0, " +
            "\"i\":5, \"lg\":null, \"shortArr\":[\"a\", 1.1, null], " +
            "\"stringArr\":[null, 1]}";
        jo = JsonObject.parse(text);
        t = new SerializableClass();
        t.fromJsonObject(jo);
        assertTrue(t.i == 5, "json to class");

        text = "{\"dummyArr\":[{\"key\":\"v1\"},null,{\"key\":\"v2\"}]}";
        jo = JsonObject.parse(text);
        t.nullArr = new int[](1);
        t.fromJsonObject(jo);
        assertTrue(t.nullArr == null, "j null array");
        assertTrue(t.dummyArr.length == 3, "j array");
        assertTrue(t.dummyArr[0].key == "v1", "j array 0");
        assertTrue(t.dummyArr[1] == null, "j array 1");
        assertTrue(t.dummyArr[2].key == "v2", "j array 2");

        var s = new ScalarTest();
        text = "{\"key\": 17}";
        jo = JsonObject.parse(text);
        s.fromJsonObject(jo);
        assertTrue(s.key.intValue() == 17, "Integer");
        jo = JsonObject.parse("{}");
        s.fromJsonObject(jo);
        assertTrue(s.key == null, "null Integer");
    }

    static int main(String[] argv) {
        var test = new SerializableTest();
        test.testSerializableClass();
        return test.exit();
    }
}
