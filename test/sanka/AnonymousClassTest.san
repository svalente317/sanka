// -*- mode: Java; -*-
package sanka.test;
import sanka.lang.Runnable;

class AnonymousMaker {
    String firstName;
    String lastName;

    Runnable makeRunnable(String[] results) {
        var fullName = this.firstName + " " + this.lastName;
        return new with fullName, results {
            // run() is a method in the new unnamed class.
            // This class has no relationship to the AnonymousMaker class.
            // It's not a subclass, it can't access instance or local
            // variables, etc.
            //
            void run() {
                this.results.add(this.fullName);
            }
        };
    }
}

class AtThisUser {
    String[] results;

    Runnable makeUser() {
        return new {
            void run() {
                @this.results.add("used");
            }
        };
    }
}

class AnonymousClassTest extends BaseTest {
    /**
     * Briefly create an instance of the AnonymousMaker class. The instance
     * is used and then discarded. When this function returns, that object
     * may be garbage collected, but the new Runnable object remain live.
     */
    Runnable makeRunnableOnly(String[] results) {
        var parent = new AnonymousMaker();
        parent.firstName = "John";
        parent.lastName = "Doe";
        return parent.makeRunnable(results);
    }

    void testAnonymousClass() {
        var results = new String[];
        var runnable = makeRunnableOnly(results);
        runnable.run();
        assertString("John Doe", results[0], "runnable results");

        var user = new AtThisUser(){results: results};
        runnable = user.makeUser();
        runnable.run();
        assertString("used", results[1], "at this test");
    }

    static int main(String[] argv) {
        var test = new AnonymousClassTest();
        test.testAnonymousClass();
        return test.exit();
    }
}
